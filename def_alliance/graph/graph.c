#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "graph.h"

static void error(const char * msg)
{
    fprintf(stderr, "ERROR: %s\n", msg);
    // TODO
}

struct graph new_graph(uint64_t nvertices)
{
    struct graph g;
    g.n = nvertices;
    g.v = malloc(nvertices * sizeof(struct vertex));

    if (!g.v) {
        error("Memory allocation for vertices table failed");
    }

    return g;
}
void add_edge_to(struct vertex * v, uint64_t to)
{
    struct edge * e = NULL;

    if (v->edge) {
        struct edge * next = v->edge;

        while (next) {
            if (next->to == to)
                return; // edge already exists
            e = next;
            next = next->next;
        }

        e->next = malloc(sizeof(struct edge));
        e = e->next;
    } else {
        // There are no edges for this vertex yet
        v->edge = malloc(sizeof(struct edge));
        e = v->edge;
    }

    if (!e) {
        error("Memory allocation for edge failed");
        return;
    }

    e->next = NULL;
    e->to = to;
}

struct vertex * get_vertex(struct graph * g, uint64_t index)
{
    return &g->v[index];
}

void add_edge(struct graph * g, uint64_t from, uint64_t to)
{
    add_edge_to(get_vertex(g, from), to);
}

void delete_graph(struct graph * g)
{
    struct edge * e, * e_next;

    if (g->v == NULL) {
        error("Vertices table cannot be freed, because it is not allocated");
        return;
    }

    for (int i = 0; i < g->n; i++) {
        e = g->v[i].edge;
        while (e) {
            e_next = e->next;
            free(e);
            e = e_next;
        }
    }

    free(g->v);
}

void print_graph(struct graph * g)
{
    struct edge * e;
    printf("N=%lu\n", g->n);
    for (uint64_t i = 0; i < g->n; i++) {
        printf("  %lu :", i);
        e = g->v[i].edge;
        while (e) {
            printf(" %lu", e->to);
            e = e->next;
        }
        printf(";\n");
    }
}

// Calculates the number of vertices of the graph
// Returns the offset at which the adjacency matrix starts
int N_inverse(uint64_t * out, const char * bytes)
{
    int nbytes = 0;
    uint64_t multiplier = 1;
    uint64_t result = 0;

    if (bytes[0] != 126) {
        result = (uint64_t) (bytes[0] - 63);
        nbytes = 1;
    } else if (bytes[1] != 126) {
        // N is encoded on bytes 1:3
        for (int i = 3; i >= 1; i--) {
            result += (bytes[i] - 63)  * multiplier;
            multiplier *= 64;  // each byte/character contains 6 bits
        }
        nbytes = 4;
    } else {
        // N is encoded on bytes 2:8
        for (int i = 8; i >= 2; i--) {
            result += (bytes[i] - 63)  * multiplier;
            multiplier *= 64;  // each byte/character contains 6 bits
        }
        nbytes = 8;
    }

    *out = result;
    return nbytes;
}

struct graph parse_graph6(const char * buff)
{
    int len = strlen(buff);
    uint64_t nvertices = 0;
    int offset = N_inverse(&nvertices, buff);

    struct graph g = new_graph(nvertices);
    int k = 1;
    uint8_t x;
    const char * p = buff + offset;

    for (int j = 1; j < nvertices; ++j) {
        for (int i = 0; i < j; ++i) {

            if (--k == 0) {
                k = 6;
                x = *(p++) - 63;

                if (--len < 0) {
                    error("Adjacency matrix truncated in graph");
                }
            }

            if (x & 32) {
                add_edge(&g, i, j);
                add_edge(&g, j, i);
            }

            x <<= 1;
        }
    }

    return g;
}

int main(void)
{
    struct graph g;
    g = parse_graph6("I?rFUzsjw");
    print_graph(&g);
    g = parse_graph6("~?Br?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????@???????????C???????????@????????????_???????????A????????????C????????????C????????????A?????????????_?????????????????????????????????????????????????????????????????????????????????????????????_?????????????A??????????????C??????????????C??????????????@??????????????@???????????????C???C???????????O???O???????????_???_???????????_???_???????????G???G???????????G???G?????????????A_??????????????AA????????????????c???????????????GC???????????????C@???????????????O@????????????????C??C??????????????O??O_?????????????_??_??????????????_??`??????????????G??O??????????????G??CK??????????????????_?????????????????D??????????????????A??????????????????H???????????????????_?????????????????@C???????????????????O???????????????????_???????????????????_???????????????????G???????????????????G???????????????????_??????????????????_A??????????????????A?C??????????????????C?C??????????????????C?A??????????????????@??_?????????????????@??C????????????????C????O????????????????O????_????????????????_????_????????????????_????O????????????????G????C????????????????G?????_????????????????_????A????????????????A?????C????????????????C?????C????????????????C?????A????????????????@??????_???????????????@??????C????????????????C??????O????????????????O??????_????????????????_??????_????????????????_??????O????????????????G??????C????????????????G???????_???????????????????????A????????????????????????C????????????????????????C????????????????????????A?????????????????????????_????????????????????????C?????????????????????????O?????????????????????????_?????????????????????????_?????????????????????????O?????????????????????????C??????????????????????????_?????????????????_???????A?????????????????@????????C??????????????????_???????C?????????????????A????????@?????????????????O????????@?????????????????A?????????C?????????????????A?????????O?????????????????C?????????_????????????????A??????????_????????????????@??????????O?????????????????O?????????C?????????????????C??????????_????A??????????????????????A????C???????????????????????C????G???????????????????????C????G???????????????????????A????C????????????????????????_????_????????????????????C??C????????????????C?????????O??G????????????????O?????????_??G????????????????_?????????_??G????????????????_?????????O??_????????????????G?????????C?@?????????????????G??????????_??O????????????????_?????????A???_???????????????A??????????C??O????????????????C??????????C??G????????????????C??????????@??@????????????????@??????????@??@????????????????@??????????????CC??????????????????????????????AA?????????????????????????????@@???????????????????????????????GG?????????????????????????????@@???????????????????????????????OO?????????????????????????????_????_??????????????????????????A????A????????????????C??????????C????C???????????????????????????C????C????????????????G??????????A????@????????????????????????????_???@????????????????@?????????C????C????????????????C???????????O????O????????????????O???????????_????_????????????????_???????????_????_????????????????_???????????G????O????????????????G???????????G????C????????????????G???_???????????????????_?????????????A???????????????????A????????????C?C???????????????????C??????????????C???????????????????C????????????G?@???????????????????@??????????????@???????????????????@????????????@??C???????????????????C???????????????O???????????????????O???????????????_???????????????????_???????????????_???????????????????_???????????????G???????????????????G???????????????G???????????????????G????????????????_???????????????????_???????????_???A???????????????????A???????????A????C???????????????????C???????????C????C???????????????????C???????????C????@???????????????????@???????????@????@???????????????????@???????????@?????C???????????????????C????????C??C?????O???????????????????O????????O??O?????_???????????????????_????????_??_?????_???????????????????_????????_??_?????G???????????????????G????????G??G?????G???????????????????G????????G??G??????_???????????????????_??????_?_????????A???????????????????A??????A?A?????????C???????????????????C??????C?C?????????C???????????????????C??????C?C?????????@???????????????????@??????@?@?????????@???????????????????@??????@?@????????????C???????????????????C??C???C????????????O???????????????????O??O???O????????????_???????????????????_??_???_????????????_???????????????????_??_???_????????????G???????????????????G??G???G????????????G???????????????????G??G???G????");
    print_graph(&g);
    return 0;
}